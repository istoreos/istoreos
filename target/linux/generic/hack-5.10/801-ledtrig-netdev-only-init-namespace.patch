From 62c679f6b4ca68841a446339ea80ae0e431947e6 Mon Sep 17 00:00:00 2001
From: Liangbin Lian <jjm2473@gmail.com>
Date: Tue, 26 Dec 2023 14:08:01 +0800
Subject: [PATCH] ledtrig-netdev: we only care about new device in init
 namespace

Signed-off-by: Liangbin Lian <jjm2473@gmail.com>
---
 drivers/leds/trigger/ledtrig-netdev.c | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/drivers/leds/trigger/ledtrig-netdev.c b/drivers/leds/trigger/ledtrig-netdev.c
index d5e774d83..32c2b65ce 100644
--- a/drivers/leds/trigger/ledtrig-netdev.c
+++ b/drivers/leds/trigger/ledtrig-netdev.c
@@ -306,9 +306,10 @@ static int netdev_trig_notify(struct notifier_block *nb,
 	    && evt != NETDEV_CHANGENAME)
 		return NOTIFY_DONE;
 
-	if (!(dev == trigger_data->net_dev ||
-	      (evt == NETDEV_CHANGENAME && !strcmp(dev->name, trigger_data->device_name)) ||
-	      (evt == NETDEV_REGISTER && !strcmp(dev->name, trigger_data->device_name))))
+	if (!(dev == trigger_data->net_dev || 
+		((evt == NETDEV_CHANGENAME || evt == NETDEV_REGISTER)
+			&& net_eq(dev_net(dev), &init_net)
+			&& !strcmp(dev->name, trigger_data->device_name))))
 		return NOTIFY_DONE;
 
 	cancel_delayed_work_sync(&trigger_data->work);
@@ -325,8 +326,10 @@ static int netdev_trig_notify(struct notifier_block *nb,
 		trigger_data->net_dev = dev;
 		break;
 	case NETDEV_UNREGISTER:
-		dev_put(trigger_data->net_dev);
-		trigger_data->net_dev = NULL;
+		if (dev->reg_state >= NETREG_UNREGISTERING) {
+			dev_put(trigger_data->net_dev);
+			trigger_data->net_dev = NULL;
+		}
 		break;
 	case NETDEV_UP:
 	case NETDEV_CHANGE:
-- 
2.31.0

